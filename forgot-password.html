<!-- Добавьте перед закрывающим </head> -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
    // Инициализация EmailJS (замените на ваш Public Key)
    emailjs.init(bJjaG2LA634-ejjBI);
</script>

<script>
    let currentStep = 1;
    let timerInterval;
    let timeLeft = 60;
    let generatedCode = '';

    // Переключение видимости пароля
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // Навигация по шагам
    function goToStep(step) {
        document.getElementById('stepEmail').style.display = step === 1 ? 'block' : 'none';
        document.getElementById('stepCode').style.display = step === 2 ? 'block' : 'none';
        document.getElementById('stepNewPassword').style.display = step === 3 ? 'block' : 'none';
        document.getElementById('stepSuccess').style.display = step === 4 ? 'block' : 'none';
        currentStep = step;
    }

    // Генерация кода
    function generateCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Отправка кода через EmailJS
    document.getElementById('emailForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const button = document.getElementById('sendCodeButton');
        const originalText = button.innerHTML;

        // Валидация email
        if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            alert('Пожалуйста, введите корректный email');
            return;
        }

        // Показываем загрузку
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
        button.disabled = true;

        // Генерируем код
        generatedCode = generateCode();
        
        // Отправка через EmailJS
        emailjs.send(service_uiqgh59, template_mmb8erl, {
            to_email: email,
            code: generatedCode,
            from_name: "bsk"
        })
        .then(function(response) {
            console.log('SUCCESS!', response.status, response.text);
            
            // Сохраняем данные для проверки
            const recoveryData = {
                email: email,
                code: generatedCode,
                timestamp: Date.now()
            };
            localStorage.setItem('recoveryData', JSON.stringify(recoveryData));
            
            alert('Код подтверждения отправлен на вашу почту!');
            button.innerHTML = originalText;
            button.disabled = false;
            
            // Переходим к шагу с кодом
            goToStep(2);
            startTimer();
            
        }, function(error) {
            console.log('FAILED...', error);
            alert('Ошибка при отправке кода. Попробуйте еще раз.');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    });

    // Таймер для повторной отправки кода
    function startTimer() {
        timeLeft = 60;
        const timerElement = document.getElementById('timer');
        const resendLink = document.getElementById('resendLink');
        
        timerElement.style.display = 'block';
        resendLink.style.display = 'none';
clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            timerElement.textContent = `Отправить код повторно через: ${timeLeft} сек`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerElement.style.display = 'none';
                resendLink.style.display = 'block';
            }
        }, 1000);
    }

    // Повторная отправка кода
    document.getElementById('resendLink').addEventListener('click', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        generatedCode = generateCode();
        
        // Отправка через EmailJS
        emailjs.send(service_uiqgh59, template_mmb8erl, {
            to_email: email,
            code: generatedCode,
            from_name: "bsk"
        })
        .then(function(response) {
            // Обновляем в localStorage
            const recoveryData = JSON.parse(localStorage.getItem('recoveryData') || '{}');
            recoveryData.code = generatedCode;
            recoveryData.timestamp = Date.now();
            localStorage.setItem('recoveryData', JSON.stringify(recoveryData));
            
            alert('Новый код отправлен на вашу почту!');
            startTimer();
        }, function(error) {
            alert('Ошибка при отправке кода. Попробуйте еще раз.');
        });
    });

    // Ввод кода подтверждения
    const codeInputs = document.querySelectorAll('.code-input');
    codeInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            const value = e.target.value.replace(/[^0-9]/g, '');
            this.value = value;
            
            if (value.length === 1) {
                this.classList.add('filled');
                
                // Переход к следующему полю
                if (index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }
            } else {
                this.classList.remove('filled');
            }
            
            // Проверка заполненности всех полей
            const allFilled = Array.from(codeInputs).every(input => input.value.length === 1);
            document.getElementById('verifyCodeButton').disabled = !allFilled;
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                codeInputs[index - 1].focus();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
            if (pasteData.length === 6) {
                codeInputs.forEach((input, i) => {
                    input.value = pasteData[i] || '';
                    input.classList.toggle('filled', pasteData[i] !== '');
                });
                document.getElementById('verifyCodeButton').disabled = false;
            }
        });
    });

    // Подтверждение кода
    document.getElementById('verifyCodeButton').addEventListener('click', function() {
        const button = this;
        const originalText = button.innerHTML;
        const email = document.getElementById('email').value;
        const codeInputs = document.querySelectorAll('.code-input');
        const enteredCode = Array.from(codeInputs).map(input => input.value).join('');
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Проверка...';
        button.disabled = true;

        setTimeout(() => {
            // Проверяем код из localStorage
            const recoveryData = JSON.parse(localStorage.getItem('recoveryData') || '{}');
            const isCodeValid = (
                recoveryData.email === email && 
                recoveryData.code === enteredCode && 
                (Date.now() - recoveryData.timestamp) < 10 * 60 * 1000 // 10 минут
            );
            
            if (isCodeValid) {
alert('Код подтвержден успешно!');
                // Переходим к шагу с новым паролем
                goToStep(3);
            } else {
                alert('Неверный или устаревший код!');
                // Очищаем поля кода при ошибке
                codeInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('filled');
                });
                codeInputs[0].focus();
                document.getElementById('verifyCodeButton').disabled = true;
            }
            
            button.innerHTML = originalText;
            button.disabled = false;
        }, 1000);
    });

    // Проверка силы пароля
    document.getElementById('newPassword').addEventListener('input', function() {
        const password = this.value;
        const strengthFill = document.getElementById('strengthFill');
        let strength = 0;
        
        if (password.length >= 6) strength += 1;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength += 1;
        if (password.match(/\d/)) strength += 1;
        if (password.match(/[^a-zA-Z\d]/)) strength += 1;
        
        strengthFill.className = 'strength-fill';
        if (strength === 1) strengthFill.classList.add('weak');
        else if (strength === 2 || strength === 3) strengthFill.classList.add('medium');
        else if (strength === 4) strengthFill.classList.add('strong');
    });

    // Сохранение нового пароля
    document.getElementById('newPasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmNewPassword').value;
        const button = document.getElementById('savePasswordButton');
        const originalText = button.innerHTML;

        if (newPassword !== confirmPassword) {
            alert('Пароли не совпадают!');
            return;
        }

        if (newPassword.length < 6) {
            alert('Пароль должен содержать минимум 6 символов');
            return;
        }

        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохранение...';
        button.disabled = true;

        setTimeout(() => {
            alert('Пароль успешно изменен!');
            // Очищаем данные восстановления
            localStorage.removeItem('recoveryData');
            // Переходим к шагу успеха
            goToStep(4);
        }, 1500);
    });

    // Анимация для логотипа
    const logo = document.querySelector('.logo');
    logo.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.05)';
    });
    
    logo.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
    });
</script>
